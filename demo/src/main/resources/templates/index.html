<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>UPB Tareas (JPA)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="text-center mb-4">Gestor de Estudiantes</h2>

            <!-- Formulario Crear -->
            <div class="card p-3 mb-3 shadow-sm">
                <form id="studentForm" class="row g-2">
                    <div class="col-md-3">
                        <input id="inputId" type="number" class="form-control" placeholder="ID" required>
                    </div>
                    <div class="col-md-4">
                        <input id="inputNombre" type="text" class="form-control" placeholder="Nombre" required>
                    </div>
                    <div class="col-md-4">
                        <input id="inputCarrera" type="text" class="form-control" placeholder="Carrera" required>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button id="createBtn" class="btn btn-primary" type="submit">Crear</button>
                    </div>
                </form>
                <div id="alert" class="mt-2"></div>
            </div>

            <!-- Barra Buscar + Listar -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>Estudiantes</h5>
                <div class="d-flex gap-2 flex-wrap">

                    <input id="searchId" type="number"
                        class="form-control form-control-sm"
                        placeholder="Buscar por ID">

                    <input id="searchNombre" type="text"
                        class="form-control form-control-sm"
                        placeholder="Buscar por Nombre">

                    <button id="searchBtn"
                        class="btn btn-outline-primary btn-sm">
                        Buscar ID
                    </button>

                    <button id="searchNombreBtn"
                        class="btn btn-outline-success btn-sm">
                        Buscar Nombre
                    </button>

                    <button id="listBtn"
                        class="btn btn-outline-secondary btn-sm">
                        Listar
                    </button>

                </div>
            </div>

            <!-- Lista -->
            <div id="studentsList" class="list-group"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('studentForm');
        const alertBox = document.getElementById('alert');
        const studentsList = document.getElementById('studentsList');

        const listBtn = document.getElementById('listBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchNombreBtn = document.getElementById('searchNombreBtn');

        function showAlert(message, type = 'success') {
            alertBox.innerHTML =
                `<div class="alert alert-${type}" role="alert">${message}</div>`;
            setTimeout(() => alertBox.innerHTML = '', 3000);
        }

        async function createStudent(event) {
            event.preventDefault();

            const id = parseInt(document.getElementById('inputId').value, 10);
            const nombre = document.getElementById('inputNombre').value;
            const carrera = document.getElementById('inputCarrera').value;

            const body = { id, nombre, carrera };

            try {
                const res = await fetch('/estudiantes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.status === 201) {
                    showAlert('Estudiante creado', 'success');
                    form.reset();
                    listStudents();
                } else if (res.status === 409) {
                    showAlert('Id inválido o repetido', 'warning');
                } else {
                    showAlert('Error al crear estudiante', 'danger');
                }

            } catch (err) {
                showAlert('Error de red', 'danger');
            }
        }

        async function listStudents() {
            try {
                const res = await fetch('/estudiantes');

                if (!res.ok) {
                    showAlert('Error obteniendo lista', 'danger');
                    return;
                }

                const data = await res.json();
                renderList(data);

            } catch (err) {
                showAlert('Error de red', 'danger');
            }
        }

        async function searchStudent() {

            const id = document.getElementById('searchId').value;

            if (!id) {
                showAlert('Ingrese un ID para buscar', 'warning');
                return;
            }

            try {
                const res = await fetch(`/estudiantes/${id}`);

                if (res.status === 404) {
                    showAlert('Estudiante no encontrado', 'warning');
                    studentsList.innerHTML = '';
                    return;
                }

                if (!res.ok) {
                    showAlert('Error en la búsqueda', 'danger');
                    return;
                }

                const data = await res.json();
                renderList([data]);

            } catch (err) {
                showAlert('Error de red', 'danger');
            }
        }

        async function searchByNombre() {

            const nombre = document.getElementById('searchNombre').value;

            if (!nombre) {
                showAlert('Ingrese un nombre para buscar', 'warning');
                return;
            }

            try {
                const res = await fetch(`/estudiantes/search?nombre=${encodeURIComponent(nombre)}`);

                if (!res.ok) {
                    showAlert('Error en la búsqueda', 'danger');
                    return;
                }

                const data = await res.json();

                if (data.length === 0) {
                    showAlert('No se encontraron coincidencias', 'warning');
                }

                renderList(data);

            } catch (err) {
                showAlert('Error de red', 'danger');
            }
        }

        function renderList(arr) {
            studentsList.innerHTML = '';

            if (!arr || arr.length === 0) {
                studentsList.innerHTML =
                    '<div class="alert alert-secondary">No hay estudiantes</div>';
                return;
            }

            arr.forEach(s => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerText = `ID: ${s.id} — ${s.nombre} (${s.carrera})`;
                studentsList.appendChild(item);
            });
        }

        form.addEventListener('submit', createStudent);
        listBtn.addEventListener('click', listStudents);
        searchBtn.addEventListener('click', searchStudent);
        searchNombreBtn.addEventListener('click', searchByNombre);

        listStudents();
    </script>
</body>

</html>
